OAuth is a protocol used by Authorization Servers to give a client limited API access on behalf of a user.

1. Client requests API access on behalf of a client
2. Resource owner grants access for the client to access the API
3. AS returns an access token
4. Access token is used by client when interacting with API
5. API validates token with AS and provides limited access to the client based on the token's scopes

![[OAuth2.jpg]]

# Scopes

Scopes are defined within the AS and given in the access token. 

Each scope is supposed to represent certain permissions or [[Authorization|authorization]] level which should be enforced on the API side.

# Clients

Client must be registered with the AS and gets a unique client ID.

Scopes are defined per client.

**Public Clients** are browsers or mobile apps.

**Confidential Clients** are other servers which can use their own credentials to identify themselves.

# Grants

Grants are how the user authenticates themselves to the AS therefore allowing the client access to the API.

## ROPC Grant

ROPC Grant is just the users credentials! This is obviously a bad approach.

## Client Credential Grant

**Client Credential Grant** is where the client uses its own credentials. Only possible for confidential clients.

Clients will authenticate and get access token from one call to the token endpoint. 

## Authorization Code Grant

Authorization Code Grant is a common and secure method where the user logs in through the AS to grant access.

1. Client redirects to AS with client id, scope, registered redirect uri, and state token
2. User logs in on AS
3. AS uses redirect uri to redirects back to client with authorization code and state token
4. Client checks that the state token matches the one sent in to verify the AS is responding to their request
5. Client uses AS token endpoint to exchange authorization code for access token
6. Client trades the authorization code for the access token while providing client id, grant type, authorization code, and redirect uri called

Redirect uri's are registered before hand to prevent hacker from redirecting to their endpoint.

Commonly used with [[Cookies]] for SSO functionality

#### PKCE

PKCE is a method of securing public clients that make requests to the AS token endpoint.

1. Client generates a PKCE value, hashes it, and submits it to the AS authorization endpoint
2. When exchanging the auth token for the access token it must also submit the unhashed PKCE value
3. AS will validate the PKCE value by hashing it and confirming the values match

This helps secure the hand-off because an attacker would need to know both the auth token received from the AS and PKCE value generated by the client.

## Implicit Grant

Implicit Grant is an older version of the authorization code grant where after login the AS redirects to the client with the access token. This can be insecure, since it can be stolen from the browser during the redirect.

## Client Credentials Grant

Client uses it's own registered credentials to get access token from the Authorization Server.

## JWT Bearer Grant

Client provides a signed JWT token in exchange for access token. 

The AS must be registered with the public key.

Endpoints for rotating the public key.

# Refresh Token

Refresh token can be returned with access token and can be used to get new access tokens.

Refresh token is short lived and only seen by the client so it is more secure than an access token.

The refresh token can change on each exchange.

The refresh token allows for the client to managed access how they see fit.

# Validate Token

The API needs to validate the token passed in from the client.

## Introspection

1. Register client with AS and get credentials in return
2. Submit token to AS introspection endpoint along with credentials

Result can be cached so that validation requests aren't needed for every request but you could accept an invalidated token

## Signed Tokens

1. AS signs token with private key
2. JWT can be validated with AS public key held by API

No need for validation calls.

How do you revoke?

# Token Revocation

Submit access token and credentials to the revoke endpoint.

Only the client can use the revoke endpoint.